# DDEV Migration Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace the existing wodby/docker4drupal (`docker-compose.yml` + `.env`) local dev stack with DDEV.

**Architecture:** DDEV manages PHP 8.3, MariaDB 11.4, nginx, and Mailpit as built-in services. Database credentials are injected via a `settings.ddev.php` file that DDEV auto-generates on `ddev start`. The existing `settings.local.php` is preserved for dev-only Drupal settings.

**Tech Stack:** DDEV, Drupal 11, PHP 8.3, MariaDB 11.4, Mailpit (built-in to DDEV ≥ 1.22)

---

### Task 1: Initialize DDEV config

**Files:**
- Create: `.ddev/config.yaml` (generated by ddev)

**Step 1: Run ddev config**

```bash
ddev config \
  --project-name=every-game \
  --project-type=drupal11 \
  --docroot=web \
  --php-version=8.3 \
  --database=mariadb:11.4
```

Expected output includes: `Configuration complete. You may now run 'ddev start'.`

**Step 2: Verify `.ddev/config.yaml` was created**

Check that `.ddev/config.yaml` exists and contains the right values:

```bash
cat .ddev/config.yaml
```

Expected: `name: every-game`, `type: drupal11`, `docroot: web`, `php_version: "8.3"`, `database: {type: mariadb, version: "11.4"}`

**Step 3: Commit**

```bash
git add .ddev/
git commit -m "feat: add DDEV configuration"
```

---

### Task 2: Update settings.php — remove Dotenv bootstrap and $_ENV database config

**Files:**
- Modify: `web/sites/default/settings.php:1-7` (remove Dotenv bootstrap)
- Modify: `web/sites/default/settings.php:867-878` (remove $_ENV database config)
- Modify: `web/sites/default/settings.php` (add settings.ddev.php include)

**Context:** `settings.php` currently bootstraps Symfony Dotenv at the top (lines 1–7) and defines `$databases` from `$_ENV` at the bottom (lines 867–878). Both need to be replaced with DDEV's approach.

**Step 1: Remove the Dotenv bootstrap at the top of settings.php**

Remove these lines from the very top of `web/sites/default/settings.php`:

```php
use Symfony\Component\Dotenv\Dotenv;

(new Dotenv())->bootEnv(DRUPAL_ROOT . '/../.env');
```

The file should now start with `<?php` followed by `// phpcs:ignoreFile`.

**Step 2: Remove the $_ENV database block at the bottom of settings.php**

Remove these lines from the end of `web/sites/default/settings.php` (currently lines 867–878):

```php
$databases['default']['default'] = [
	'database' => $_ENV['DB_NAME'],
	'username' => $_ENV['DB_USER'],
	'password' => $_ENV['DB_PASSWORD'],
	'prefix' => '',
	'host' => $_ENV['DB_HOST'],
	'port' => $_ENV['DB_PORT'],
	'namespace' => 'Drupal\\Core\\Database\\Driver\\mysql',
	'driver' => $_ENV['DB_DRIVER'],
	'isolation_level' => 'READ COMMITTED',
	'autoload' => 'core/modules/mysql/src/Driver/Database/mysql/',
];
```

**Step 3: Add the settings.ddev.php include at the end of settings.php**

After the existing `settings.local.php` include block (around line 864–866), add:

```php
// Automatically generated include for settings managed by ddev.
if (file_exists($app_root . '/' . $site_path . '/settings.ddev.php') && getenv('IS_DDEV_PROJECT') == 'true') {
  include $app_root . '/' . $site_path . '/settings.ddev.php';
}
```

**Step 4: Commit**

```bash
git add web/sites/default/settings.php
git commit -m "feat: replace Dotenv DB config with DDEV settings include"
```

---

### Task 3: Update settings.local.php — trusted host pattern

**Files:**
- Modify: `web/sites/default/settings.local.php:66`

**Context:** `settings.local.php` has a `trusted_host_patterns` entry for `every_game.docker.localdev`. Replace it with the DDEV URL. Note: `settings.local.php` is gitignored so this change is local only.

**Step 1: Update the trusted_host_patterns line**

In `web/sites/default/settings.local.php`, replace:

```php
$settings['trusted_host_patterns'] = ['.*', 'every_game.docker.localdev$'];
```

with:

```php
$settings['trusted_host_patterns'] = ['.*', 'every-game\.ddev\.site$'];
```

**Step 2: Verify the file looks right**

```bash
grep trusted_host_patterns web/sites/default/settings.local.php
```

Expected: `$settings['trusted_host_patterns'] = ['.*', 'every-game\.ddev\.site$'];`

No commit needed — this file is gitignored.

---

### Task 4: Remove old docker stack files

**Files:**
- Delete: `docker-compose.yml`
- Delete: `.env`
- Delete: `.env.example`

**Step 1: Delete the files**

```bash
rm docker-compose.yml .env .env.example
```

**Step 2: Verify they're gone**

```bash
ls docker-compose.yml .env .env.example 2>&1
```

Expected: `No such file or directory` for all three.

**Step 3: Commit**

```bash
git add -u docker-compose.yml .env.example
git commit -m "chore: remove wodby docker-compose stack"
```

Note: `.env` is gitignored so it won't appear in `git status` — just delete it locally.

---

### Task 5: Update .gitignore

**Files:**
- Modify: `.gitignore`

**Context:** `.gitignore` has a `/.env` entry from the old stack. Since DDEV doesn't use a root `.env`, that entry can stay (harmless) but we should add a note. More importantly, `.ddev/` should be committed (DDEV creates its own internal `.ddev/.gitignore` for files that shouldn't be committed). No changes needed to `.gitignore` unless DDEV's auto-generated `.ddev/.gitignore` doesn't cover everything.

**Step 1: Check DDEV's .gitignore**

```bash
cat .ddev/.gitignore
```

Expected: DDEV auto-generates this with entries like `*.log`, `.ddev-docker-compose*`, etc.

**Step 2: Verify `.ddev/config.yaml` is tracked**

```bash
git status .ddev/
```

Expected: `.ddev/config.yaml` is tracked; internal DDEV files are excluded by `.ddev/.gitignore`.

No further changes needed if DDEV's own `.gitignore` is in place.

---

### Task 6: Start DDEV and verify

**Step 1: Start DDEV**

```bash
ddev start
```

Expected: Services start successfully. Output ends with something like:
```
Successfully started every-game
Project can be reached at https://every-game.ddev.site
```

**Step 2: Verify the site loads**

```bash
ddev launch
```

Expected: Browser opens to `https://every-game.ddev.site` and the Drupal site loads (may show DB error until DB is imported — that's expected at this stage).

**Step 3: Verify drush works through DDEV**

```bash
ddev drush status
```

Expected: Drush bootstrap shows Drupal 11, PHP 8.3, MariaDB. Database may show "not connected" until data is imported — that's fine.

**Step 4: Verify Mailpit is accessible**

```bash
ddev launch --mailpit
```

Expected: Browser opens to the Mailpit UI.

---

### Task 7: Update CLAUDE.md dev commands

**Files:**
- Modify: `CLAUDE.md`

**Step 1: Update the Development Commands section**

Replace the current "Theme Development" and Drush command examples that reference docker with DDEV equivalents. Add a new "Local Development Environment" section before the existing commands:

```markdown
## Local Development Environment

The project uses [DDEV](https://ddev.readthedocs.io/) for local development.

### DDEV Commands
```bash
# Start environment
ddev start

# Stop environment
ddev stop

# Open site in browser
ddev launch

# Open Mailpit (email catcher)
ddev launch --mailpit

# SSH into the web container
ddev ssh

# Enable/disable Xdebug
ddev xdebug on
ddev xdebug off

# Import a database dump
ddev import-db --file=dump.sql.gz
```
```

Also update drush commands to use `ddev drush` instead of `vendor/bin/drush`, and theme commands to use `ddev npm` if needed, or note that npm runs on the host.

**Step 2: Commit**

```bash
git add CLAUDE.md
git commit -m "docs: update CLAUDE.md with DDEV development commands"
```

---

## Post-Migration: Import Database from Production

After the environment is running, import the production database:

```bash
# Option 1: Direct drush sql-sync (requires drush aliases configured)
ddev drush sql-sync @prod @self

# Option 2: Manual dump and import
# On production: vendor/bin/drush sql-dump --gzip > dump.sql.gz
# Locally:
ddev import-db --file=dump.sql.gz
ddev drush cr
```
